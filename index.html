<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="My Schedule">
    <title>My Daily Schedule</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #2a2a44;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0b0;
            --accent: #ff3b5e;
            --accent-hover: #e62c4a;
        }

        body.monochrome {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --accent: #ffffff;
            --accent-hover: #dddddd;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 600px;
        }
        .schedule-item {
            background-color: var(--bg-secondary);
            transition: all 0.2s ease-in-out;
            cursor: grab;
        }
        .schedule-item:active {
            cursor: grabbing;
        }
        .schedule-item.dragging {
            opacity: 0.5;
            background-color: #4a4a6b;
            transform: scale(1.02);
        }
        .input-group, .calendar-grid {
            background-color: var(--bg-secondary);
        }
        .btn-primary {
            background-color: var(--accent);
            color: var(--bg-primary);
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        .calendar-cell {
            position: relative;
            background-color: var(--bg-primary);
            transition: all 0.2s ease-in-out;
        }
        .calendar-cell.today {
            border: 2px solid var(--accent);
        }
        .calendar-cell.has-tasks {
            background-color: #3b3b55;
        }
        .calendar-cell:hover {
            background-color: var(--bg-secondary);
        }
        .task-modal, .replicate-modal {
            background-color: var(--bg-primary);
        }
        /* Sidebar styles */
        #sidebar {
            width: 70px;
            background-color: var(--bg-secondary);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2rem;
            z-index: 100;
            transition: width 0.3s;
        }
        #sidebar.expanded {
            width: 200px;
        }
        #sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        .nav-item {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem 0;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
        }
        .nav-item:hover {
            background-color: #3a3a5a;
        }
        .nav-item.active {
            background-color: #4a4a6b;
        }
        .nav-text {
            display: none;
            margin-left: 0.5rem;
            white-space: nowrap;
        }
        #sidebar.expanded .nav-text {
            display: block;
        }
        .content-container {
            margin-left: 70px;
            transition: margin-left 0.3s;
        }
        #sidebar.expanded + .content-container {
            margin-left: 200px;
        }
        .floating-add-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4 flex flex-col lg:flex-row min-h-screen">
    
    <!-- Sidebar -->
    <div id="sidebar">
        <button id="sidebar-toggle" class="p-2 rounded-full hover:bg-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        <div id="schedule-tab" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M16 11h.01M9 15h.01M15 15h.01M16 19h.01M9 19h.01" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.087 2.296c.38-.415.92-.61 1.488-.591H20.5a2 2 0 012 2v14a2 2 0 01-2 2H3.5a2 2 0 01-2-2v-14c0-1.105.9-2 2-2z" />
            </svg>
            <span class="nav-text">Schedule</span>
        </div>
        <div id="calendar-tab" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M16 11h.01M9 15h.01M15 15h.01M16 19h.01M9 19h.01" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.087 2.296c.38-.415.92-.61 1.488-.591H20.5a2 2 0 012 2v14a2 2 0 01-2 2H3.5a2 2 0 01-2-2v-14c0-1.105.9-2 2-2z" />
            </svg>
            <span class="nav-text">Calendar</span>
        </div>
        <div id="ai-tab" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span class="nav-text">AI</span>
        </div>
        <div id="settings-tab" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.527.288 1.13.411 1.728.324z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span class="nav-text">Settings</span>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="content-container flex-1 p-4 lg:p-6">
        <div id="schedule-view" class="active-view">
            <h1 class="text-3xl font-bold text-center mb-2">My Schedule</h1>
            <p id="current-date" class="text-center text-gray-400 mb-6"></p>
            <p id="tasks-completed-count" class="text-center text-sm font-semibold mb-4"></p>
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">Tasks</h2>
                <button id="clear-all-btn" class="text-sm text-red-400 hover:text-red-500 font-semibold transition-colors">Clear All</button>
            </div>

            <ul id="schedule-list" class="space-y-4">
                <!-- Schedule items will be dynamically added here -->
            </ul>
        </div>

        <div id="calendar-view" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="month-year" class="text-xl font-bold text-center"></h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <div class="grid grid-cols-7 gap-2 text-center text-sm mb-4">
                <div class="text-gray-400">Sun</div>
                <div class="text-gray-400">Mon</div>
                <div class="text-gray-400">Tue</div>
                <div class="text-gray-400">Wed</div>
                <div class="text-gray-400">Thu</div>
                <div class="text-gray-400">Fri</div>
                <div class="text-gray-400">Sat</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2 calendar-grid p-4 rounded-xl"></div>
        </div>

        <div id="ai-view" class="hidden">
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl">
                <h1 class="text-3xl font-bold text-center mb-6">AI Suggestions</h1>
                <p class="text-center text-gray-400 mb-6">Let Gemini help you optimize your day. Click the button below to get suggestions based on your current schedule.</p>
                <button id="ai-suggestions-btn" class="w-full btn-primary py-3 rounded-xl font-semibold transition-transform transform hover:scale-105">
                    Get AI Suggestions
                </button>
                <div id="ai-content" class="mt-6 p-4 rounded-lg bg-gray-700">
                    <p class="text-gray-400">Suggestions will appear here...</p>
                </div>
            </div>
        </div>

        <div id="settings-view" class="hidden">
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl">
                <h1 class="text-3xl font-bold text-center mb-6">Settings</h1>
                
                <!-- API Key Input -->
                <div class="input-group p-4 rounded-lg mb-4">
                    <h2 class="text-lg font-semibold mb-2">Gemini API Key</h2>
                    <p class="text-sm text-gray-400 mb-2">Enter your API key to enable AI suggestions.</p>
                    <input type="text" id="api-key-input" placeholder="Enter API key..." class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-pink-500">
                </div>
                
                <!-- Replicate Tasks Feature -->
                <div class="input-group p-4 rounded-lg mb-4">
                    <h2 class="text-lg font-semibold mb-2">Replicate Tasks</h2>
                    <p class="text-sm text-gray-400 mb-2">Copy all tasks from one day to another.</p>
                    <div class="flex flex-col gap-4">
                        <label class="text-white">Source Date</label>
                        <input type="date" id="source-date" class="p-2 rounded-lg bg-gray-600 border border-gray-500 text-white focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <button id="replicate-btn" class="w-full btn-primary py-2 rounded-xl font-semibold transition-transform transform hover:scale-105">
                            Replicate
                        </button>
                    </div>
                </div>

                <!-- Black & White Mode -->
                <div class="input-group p-4 rounded-lg mb-4 flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Black & White Mode</h2>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="theme-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                    </label>
                </div>

                <!-- Notification Permission Section -->
                <div id="notification-permission-section" class="p-4 rounded-xl text-center" style="background-color: #3b3b55;">
                    <p class="mb-2">To get reminders, enable notifications and add this app to your home screen.</p>
                    <button id="enable-notifications" class="btn-primary py-2 px-4 rounded-full font-semibold transition-transform transform hover:scale-105">
                        Enable Notifications
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Add Button -->
    <button id="add-task-fab" class="floating-add-btn rounded-full btn-primary shadow-lg flex items-center justify-center transition-transform transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>
    
    <!-- Task Modal -->
    <div id="task-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-75 z-50">
        <div class="task-modal p-6 rounded-2xl shadow-2xl max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="task-modal-title">Add Task</h3>
                <button id="close-task-modal" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="time" id="task-time" class="w-full sm:w-1/2 p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-pink-500">
                <input type="text" id="task-name" placeholder="Task name..." class="w-full sm:w-1/2 p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>
            <textarea id="task-notes" placeholder="Notes..." rows="2" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 mb-4"></textarea>
            <input type="text" id="task-category" placeholder="Category (e.g., Work, Health)..." class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 mb-4">
            <button id="save-task-btn" class="w-full btn-primary py-3 rounded-xl font-semibold transition-transform transform hover:scale-105">
                Save Task
            </button>
        </div>
    </div>
    
    <!-- Replicate Modal -->
    <div id="replicate-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-75 z-50">
        <div class="replicate-modal bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Replicate to...</h3>
                <button id="close-replicate-modal" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="text-gray-400 text-sm mb-4">Tap on the dates below to replicate your schedule.</p>
            <div id="replicate-calendar-grid" class="grid grid-cols-7 gap-2 calendar-grid p-4 rounded-xl"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-75 z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center transform scale-105 transition-transform">
            <p class="text-white mb-4" id="confirm-message"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full">Yes</button>
                <button id="confirm-no" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_KEY_KEY = 'gemini_api_key';
        
        // --- Core Application Logic ---
        const scheduleList = document.getElementById('schedule-list');
        const taskTimeInput = document.getElementById('task-time');
        const taskNameInput = document.getElementById('task-name');
        const taskNotesInput = document.getElementById('task-notes');
        const taskCategoryInput = document.getElementById('task-category');
        const saveTaskBtn = document.getElementById('save-task-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const enableNotificationsBtn = document.getElementById('enable-notifications');
        const notificationPermissionSection = document.getElementById('notification-permission-section');
        const aiSuggestionsBtn = document.getElementById('ai-suggestions-btn');
        const aiContent = document.getElementById('ai-content');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearText = document.getElementById('month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const currentDateElement = document.getElementById('current-date');
        const tasksCompletedCount = document.getElementById('tasks-completed-count');

        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const navItems = document.querySelectorAll('.nav-item');
        const views = document.querySelectorAll('.content-container > div');

        const addTaskFab = document.getElementById('add-task-fab');
        const taskModal = document.getElementById('task-modal');
        const closeTaskModalBtn = document.getElementById('close-task-modal');
        const taskModalTitle = document.getElementById('task-modal-title');
        
        const settingsTab = document.getElementById('settings-tab');
        const apiKeyInput = document.getElementById('api-key-input');
        const themeToggle = document.getElementById('theme-toggle');

        const replicateBtn = document.getElementById('replicate-btn');
        const sourceDateInput = document.getElementById('source-date');
        const replicateModal = document.getElementById('replicate-modal');
        const replicateCalendarGrid = document.getElementById('replicate-calendar-grid');
        const closeReplicateModal = document.getElementById('close-replicate-modal');
        let replicationSourceDate = null;
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');

        let currentViewDate = new Date();
        let selectedDate = new Date();
        let currentSchedule = [];
        let editingTaskId = null;
        
        // --- Local Storage Sync ---
        function getScheduleKey(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0); // Normalize date to avoid timezone issues
            return `schedule-${d.toISOString().slice(0, 10)}`;
        }

        function loadSchedule() {
            const storedSchedule = localStorage.getItem(getScheduleKey(selectedDate));
            currentSchedule = storedSchedule ? JSON.parse(storedSchedule) : [];
            renderSchedule();
        }

        function saveSchedule() {
            localStorage.setItem(getScheduleKey(selectedDate), JSON.stringify(currentSchedule));
            updateTaskCounts();
            displayCalendar(currentViewDate);
        }
        
        function getTaskCounts(date) {
            const key = getScheduleKey(date);
            const schedule = JSON.parse(localStorage.getItem(key) || '[]');
            const completed = schedule.filter(task => task.isCompleted).length;
            const total = schedule.length;
            return { completed, total };
        }

        function updateTaskCounts() {
            const { completed, total } = getTaskCounts(selectedDate);
            tasksCompletedCount.textContent = `Completed: ${completed}/${total} tasks`;
        }

        // --- Notification Logic ---
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                notificationPermissionSection.innerHTML = `<p class="text-red-400">Notifications are not supported by your browser.</p>`;
                return;
            }
            if (Notification.permission === 'granted') {
                notificationPermissionSection.innerHTML = `<p class="text-green-400 font-semibold">Notifications are enabled!</p>`;
            } else if (Notification.permission === 'denied') {
                notificationPermissionSection.innerHTML = `<p class="text-yellow-400">Notifications are blocked. Please enable them in your browser settings.</p>`;
            }
        }

        enableNotificationsBtn.addEventListener('click', async () => {
            if (!('Notification' in window)) return;
            const permission = await Notification.requestPermission();
            checkNotificationPermission();
        });

        function checkScheduleForNotifications() {
            if (Notification.permission === 'granted' && currentSchedule) {
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                const updatedSchedule = currentSchedule.map(task => {
                    if (task.time === currentTime && !task.notified) {
                        new Notification(`Time for: ${task.name}`, {
                            body: task.notes || 'Your scheduled time has arrived.',
                            icon: 'https://placehold.co/128x128/ff3b5e/ffffff?text=Task'
                        });
                        task.notified = true;
                    }
                    return task;
                });
                currentSchedule = updatedSchedule;
                saveSchedule();
            }
        }
        setInterval(checkScheduleForNotifications, 60000);

        // --- UI & State Management ---
        function showMessage(message) {
            confirmMessage.textContent = message;
            confirmYesBtn.classList.add('hidden');
            confirmNoBtn.textContent = 'OK';
            confirmationModal.classList.remove('hidden');
            confirmNoBtn.onclick = () => confirmationModal.classList.add('hidden');
        }

        function showConfirmation(message, onConfirm) {
            confirmMessage.textContent = message;
            confirmYesBtn.classList.remove('hidden');
            confirmNoBtn.textContent = 'Cancel';
            confirmationModal.classList.remove('hidden');
            confirmYesBtn.onclick = () => {
                onConfirm();
                confirmationModal.classList.add('hidden');
            };
            confirmNoBtn.onclick = () => confirmationModal.classList.add('hidden');
        }
        
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours, 10);
            const period = hour >= 12 ? 'PM' : 'AM';
            const formattedHour = hour % 12 || 12;
            return `${formattedHour}:${minutes} ${period}`;
        }


        function renderSchedule() {
            scheduleList.innerHTML = '';
            currentSchedule.sort((a, b) => a.time.localeCompare(b.time));
            
            if (currentSchedule.length === 0) {
                scheduleList.innerHTML = '<p class="text-center text-gray-500">No tasks for this day. Add a new one!</p>';
            }

            currentSchedule.forEach((task) => {
                const listItem = document.createElement('li');
                listItem.className = `schedule-item p-4 rounded-xl flex items-center justify-between shadow-md transition-transform transform hover:scale-105 ${task.isCompleted ? 'opacity-50 line-through' : ''}`;
                listItem.draggable = true;
                listItem.dataset.id = task.id;
                
                listItem.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', task.id);
                    e.target.classList.add('dragging');
                });
                listItem.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });

                const taskContent = document.createElement('div');
                taskContent.className = 'flex-1';
                taskContent.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        <input type="checkbox" data-id="${task.id}" ${task.isCompleted ? 'checked' : ''} class="task-checkbox h-4 w-4 rounded text-pink-500">
                        <p class="font-bold text-lg">${task.name}</p>
                    </div>
                    <p class="text-sm text-gray-400">Time: ${formatTime(task.time)} <span class="ml-2 font-semibold text-xs rounded-full p-1" style="background-color: ${getCategoryColor(task.category)}">${task.category}</span></p>
                    ${task.notes ? `<p class="text-sm text-gray-400 mt-1">Notes: ${task.notes}</p>` : ''}
                `;
                listItem.appendChild(taskContent);

                const actions = document.createElement('div');
                actions.className = 'flex items-center gap-2 ml-4';

                const editBtn = document.createElement('button');
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>`;
                editBtn.onclick = () => editTask(task);
                actions.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>`;
                deleteBtn.onclick = () => deleteTask(task.id);
                actions.appendChild(deleteBtn);
                
                listItem.appendChild(actions);
                scheduleList.appendChild(listItem);
            });

            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const taskId = e.target.dataset.id;
                    const isCompleted = e.target.checked;
                    updateTaskCompletion(taskId, isCompleted);
                });
            });

            scheduleList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(scheduleList, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    scheduleList.appendChild(draggable);
                } else {
                    scheduleList.insertBefore(draggable, afterElement);
                }
            });

            scheduleList.addEventListener('drop', (e) => {
                e.preventDefault();
                const droppedId = e.dataTransfer.getData('text/plain');
                const droppedTask = currentSchedule.find(task => task.id === droppedId);
                const updatedSchedule = [...currentSchedule.filter(task => task.id !== droppedId)];
                
                const afterElement = getDragAfterElement(scheduleList, e.clientY);
                const afterIndex = afterElement ? updatedSchedule.findIndex(task => task.id === afterElement.dataset.id) : -1;
                
                if (afterIndex === -1) {
                    updatedSchedule.push(droppedTask);
                } else {
                    updatedSchedule.splice(afterIndex, 0, droppedTask);
                }

                currentSchedule = updatedSchedule;
                saveSchedule();
            });
            updateTaskCounts();
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.schedule-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Task Actions ---
        addTaskFab.addEventListener('click', () => {
            editingTaskId = null;
            taskModalTitle.textContent = 'Add Task';
            saveTaskBtn.textContent = 'Add Task';
            taskTimeInput.value = '';
            taskNameInput.value = '';
            taskNotesInput.value = '';
            taskCategoryInput.value = '';
            taskModal.classList.remove('hidden');
        });

        closeTaskModalBtn.addEventListener('click', () => {
            taskModal.classList.add('hidden');
        });

        saveTaskBtn.addEventListener('click', () => {
            const time = taskTimeInput.value;
            const name = taskNameInput.value.trim();
            const notes = taskNotesInput.value.trim();
            const category = taskCategoryInput.value.trim() || 'General';

            if (!time || !name) {
                showMessage('Please enter both a time and a task name.');
                return;
            }

            if (editingTaskId) {
                // Edit existing task
                currentSchedule = currentSchedule.map(task => 
                    task.id === editingTaskId ? { ...task, time, name, notes, category } : task
                );
            } else {
                // Add new task
                const newTask = {
                    id: crypto.randomUUID(),
                    time,
                    name,
                    notes,
                    category,
                    isCompleted: false,
                    notified: false
                };
                currentSchedule.push(newTask);
            }

            saveSchedule();
            renderSchedule();
            taskModal.classList.add('hidden');
        });

        function deleteTask(taskId) {
            showConfirmation('Are you sure you want to delete this task?', () => {
                currentSchedule = currentSchedule.filter(task => task.id !== taskId);
                saveSchedule();
                renderSchedule();
            });
        }

        function updateTaskCompletion(taskId, isCompleted) {
            currentSchedule = currentSchedule.map(task => 
                task.id === taskId ? { ...task, isCompleted } : task
            );
            saveSchedule();
            renderSchedule();
        }

        function editTask(task) {
            editingTaskId = task.id;
            taskModalTitle.textContent = 'Edit Task';
            saveTaskBtn.textContent = 'Save Changes';
            taskTimeInput.value = task.time;
            taskNameInput.value = task.name;
            taskNotesInput.value = task.notes;
            taskCategoryInput.value = task.category;
            taskModal.classList.remove('hidden');
        }

        clearAllBtn.addEventListener('click', () => {
            showConfirmation('Are you sure you want to clear your entire schedule for the day?', () => {
                currentSchedule = [];
                saveSchedule();
                renderSchedule();
            });
        });

        // --- AI Suggestions ---
        aiSuggestionsBtn.addEventListener('click', async () => {
            aiContent.innerHTML = `<p class="text-center text-gray-400">Thinking...</p>`;

            const apiKey = localStorage.getItem(API_KEY_KEY);
            if (!apiKey) {
                aiContent.innerHTML = `<p class="text-center text-red-400">Please provide your Gemini API key in the settings tab to enable this feature.</p>`;
                return;
            }
            
            try {
                const userQuery = `My current schedule is:\n${JSON.stringify(currentSchedule, null, 2)}\n\nWhat are some helpful suggestions to improve this schedule? Give me a few actionable tips based on the tasks I have listed.`;
                const systemPrompt = "Act as a personal productivity coach and time management expert. Provide concise, actionable tips and suggestions. Keep your response brief and to the point. Give a bulleted list of suggestions.";
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (aiText) {
                    aiContent.innerHTML = aiText.replace(/\n/g, '<br>');
                } else {
                    aiContent.innerHTML = `<p class="text-center text-red-400">Failed to get a response. Please check your API key and network connection.</p>`;
                    console.error('API response error:', result);
                }
            } catch (error) {
                aiContent.innerHTML = `<p class="text-center text-red-400">An error occurred. Please check the console.</p>`;
                console.error('API call failed:', error);
            }
        });

        // --- Settings Logic ---
        apiKeyInput.addEventListener('input', (e) => {
            localStorage.setItem(API_KEY_KEY, e.target.value);
        });
        
        settingsTab.addEventListener('click', () => {
            apiKeyInput.value = localStorage.getItem(API_KEY_KEY) || '';
        });

        themeToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                document.body.classList.add('monochrome');
                localStorage.setItem('theme', 'monochrome');
            } else {
                document.body.classList.remove('monochrome');
                localStorage.setItem('theme', 'default');
            }
        });
        
        replicateBtn.addEventListener('click', () => {
            const sourceDate = sourceDateInput.value;
            if (!sourceDate) {
                showMessage("Please select a source date.");
                return;
            }
            replicationSourceDate = sourceDate;
            replicateModal.classList.remove('hidden');
            displayReplicateCalendar();
        });

        closeReplicateModal.addEventListener('click', () => {
            replicateModal.classList.add('hidden');
        });

        // --- Replicate Calendar Logic ---
        function displayReplicateCalendar() {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();

            replicateCalendarGrid.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDay = firstDayOfMonth.getDay();

            for (let i = 0; i < startingDay; i++) {
                const blankCell = document.createElement('div');
                blankCell.className = 'calendar-cell aspect-square rounded-lg flex items-center justify-center';
                replicateCalendarGrid.appendChild(blankCell);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('button');
                const dayDate = new Date(year, month, i);
                dayCell.className = `calendar-cell aspect-square rounded-lg flex items-center justify-center p-2 text-white font-bold transition-all transform hover:scale-110`;
                dayCell.textContent = i;
                
                dayCell.onclick = () => {
                    const destDate = dayDate.toISOString().slice(0, 10);
                    replicateTasks(replicationSourceDate, destDate);
                    replicateModal.classList.add('hidden');
                };
                replicateCalendarGrid.appendChild(dayCell);
            }
        }

        function replicateTasks(sourceDate, destDate) {
            const sourceKey = `schedule-${sourceDate}`;
            const sourceSchedule = JSON.parse(localStorage.getItem(sourceKey) || '[]');
            
            if (sourceSchedule.length === 0) {
                showMessage(`No tasks found for the source date.`);
                return;
            }

            const destKey = `schedule-${destDate}`;
            const destSchedule = JSON.parse(localStorage.getItem(destKey) || '[]');
            
            const mergedSchedule = [...destSchedule, ...sourceSchedule.map(task => ({
                ...task,
                id: crypto.randomUUID(),
                notified: false
            }))];
            
            localStorage.setItem(destKey, JSON.stringify(mergedSchedule));
            
            if (destDate === selectedDate.toISOString().slice(0, 10)) {
                currentSchedule = mergedSchedule;
                renderSchedule();
                displaySelectedDate();
            }
            displayCalendar(currentViewDate);
            showMessage(`Successfully replicated tasks to ${destDate}.`);
        }

        // --- Calendar Logic ---
        function displayCalendar(date) {
            const today = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();

            monthYearText.textContent = `${date.toLocaleDateString('default', { month: 'long' })} ${year}`;
            calendarGrid.innerHTML = '';

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDay = firstDayOfMonth.getDay();

            // Render blank cells for padding
            for (let i = 0; i < startingDay; i++) {
                const blankCell = document.createElement('div');
                blankCell.className = 'calendar-cell aspect-square rounded-lg flex items-center justify-center';
                calendarGrid.appendChild(blankCell);
            }

            // Render day cells
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('button');
                const dayDate = new Date(year, month, i);
                const isToday = dayDate.toDateString() === today.toDateString();
                const { completed, total } = getTaskCounts(dayDate);
                const hasTasks = total > 0;
                
                dayCell.className = `calendar-cell aspect-square rounded-lg flex flex-col items-center justify-center p-2 text-white font-bold transition-all transform hover:scale-110`;
                dayCell.classList.toggle('today', isToday);
                dayCell.classList.toggle('has-tasks', hasTasks);
                
                dayCell.innerHTML = `<span class="text-xl">${i}</span>`;
                if (hasTasks) {
                    dayCell.innerHTML += `<span class="text-xs text-pink-300 mt-1">${completed}/${total}</span>`;
                }
                dayCell.onclick = () => {
                    selectedDate = dayDate;
                    loadSchedule();
                    displaySelectedDate();
                    // Switch to schedule view
                    navItems.forEach(nav => nav.classList.remove('active'));
                    document.getElementById('schedule-tab').classList.add('active');
                    views.forEach(view => view.classList.add('hidden'));
                    document.getElementById('schedule-view').classList.remove('hidden');
                };
                calendarGrid.appendChild(dayCell);
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentViewDate.setMonth(currentViewDate.getMonth() - 1);
            displayCalendar(currentViewDate);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentViewDate.setMonth(currentViewDate.getMonth() + 1);
            displayCalendar(currentViewDate);
        });
        
        function getCategoryColor(category) {
            const colors = {
                'Work': '#3b82f6',
                'Personal': '#f87171',
                'Health': '#22c55e',
                'General': '#6b7280'
            };
            return colors[category] || '#6b7280';
        }

        function displaySelectedDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDateElement.textContent = selectedDate.toLocaleDateString(undefined, options);
        }
        
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Initial load
        window.onload = () => {
            if (localStorage.getItem('theme') === 'monochrome') {
                document.body.classList.add('monochrome');
                themeToggle.checked = true;
            }
            apiKeyInput.value = localStorage.getItem(API_KEY_KEY) || '';
            displaySelectedDate();
            loadSchedule();
            checkNotificationPermission();
        };
    </script>
</body>
</html>
